# Payment Verification Token Issue - Root Cause & Fix

## Problem Statement

Test 7 (Verify Payment) was failing with:
```json
{
    "error": "Unauthorized",
    "message": "Invalid or missing token"
}
```

Even though:
- Token IS being sent with correct "Bearer " prefix
- Token IS valid and generated by the login endpoint
- All other endpoints accepting tokens work fine

## Root Cause Analysis

### The Mismatch

**In simple_auth_views.py (Token Generation):**
```python
JWT_SECRET = getattr(settings, 'SECRET_KEY', 'your-secret-key-change-this')
JWT_ALGORITHM = getattr(settings, 'JWT_ALGORITHM', 'HS256')

# Tokens encoded with SECRET_KEY
token = jwt.encode(payload, JWT_SECRET, algorithm=JWT_ALGORITHM)
```

**In payment_views.py (Token Validation) - BEFORE FIX:**
```python
jwt_secret = os.getenv('JWT_SECRET', settings.SECRET_KEY)
jwt_algorithm = os.getenv('JWT_ALGORITHM', 'HS256')

# Tokens decoded with JWT_SECRET (wrong!)
payload = jwt.decode(token, jwt_secret, algorithms=[jwt_algorithm])
```

### Why This Fails

In render.yaml environment:
```yaml
SECRET_KEY: 4f5e2bac434c38bcf80b3f71df16ad50
JWT_SECRET: your-super-secret-jwt-key-256-bits-long-...
```

1. Token created with `SECRET_KEY = "4f5e2bac434c38bcf80b3f71df16ad50"`
2. Tried to decode with `JWT_SECRET = "your-super-secret-jwt-key-256-bits-long-..."`
3. **Secret keys don't match → JWT decode fails → Unauthorized error**

## Solution

### Code Changes in payment_views.py

**Before:**
```python
jwt_secret = os.getenv('JWT_SECRET', settings.SECRET_KEY)
```

**After:**
```python
# IMPORTANT: Must use the same SECRET_KEY used for token encoding in simple_auth_views.py
jwt_secret = getattr(settings, 'SECRET_KEY', 'your-secret-key-change-this')
```

### Why This Works

1. Both token generation (simple_auth_views.py) and validation (payment_views.py) now use `SECRET_KEY`
2. `getattr(settings, ...)` ensures we get the actual Django setting value
3. Falls back to same default as token generation for consistency

## Files Modified

- `/Users/vishaljha/Ed_tech_backend/question_solver/payment_views.py`
  - Function: `get_user_from_token()`
  - Lines: 23-50

## Testing

### Manual Verification
```bash
# Get token
TOKEN=$(curl -s -X POST "https://ed-tech-backend-tzn8.onrender.com/api/auth/login/" \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"password123"}' | \
  python3 -c "import sys, json; d=json.load(sys.stdin); print(d.get('data',{}).get('token',''))")

# Use token for payment verification
curl -X POST "https://ed-tech-backend-tzn8.onrender.com/api/payment/verify/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "razorpay_order_id": "order_xxxxx",
    "razorpay_payment_id": "pay_xxxxx",
    "razorpay_signature": "signature_xxxxx"
  }'
```

### Expected Result After Deployment
```json
{
    "error": "Payment verification failed",
    "message": "Invalid signature"
}
```
(Note: Returns validation error, not authentication error - proves token IS valid)

## Impact

### Fixed Endpoints
- ✓ `POST /api/payment/verify/` - Now accepts valid Bearer tokens
- ✓ `GET /api/payment/status/` - Now accepts valid Bearer tokens  
- ✓ `GET /api/payment/history/` - Now accepts valid Bearer tokens

### Verification
All endpoints using `get_user_from_token()` function will now properly validate JWT tokens:

```python
# All these views use get_user_from_token():
- VerifyPaymentView
- PaymentStatusView
- PaymentHistoryView
- RefundView
```

## Deployment Notes

1. Code changes committed to repository
2. Render.yaml already has correct SECRET_KEY and JWT_SECRET configured
3. On next deployment:
   - Backend will use SECRET_KEY for token operations
   - Both token generation and validation will use same secret
   - Payment verification endpoint will accept valid Bearer tokens

## Related Code

**Token Generation** (simple_auth_views.py:26):
```python
JWT_SECRET = getattr(settings, 'SECRET_KEY', 'your-secret-key-change-this')
```

**Token Validation** (payment_views.py:48 - NOW FIXED):
```python
jwt_secret = getattr(settings, 'SECRET_KEY', 'your-secret-key-change-this')
```

Both now use identical logic ✓
